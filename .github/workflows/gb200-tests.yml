name: GB200 Tests

on:
    workflow_dispatch:
        inputs:
            image:
                description: "Serving Image"
                required: true
                type: choice
                options:
                    - "nvcr.io/nvidia/ai-dynamo/sglang-runtime:0.5.1-rc0.pre1"
                    - "nvcr.io#nvidia/ai-dynamo/tensorrtllm-runtime:0.5.1-rc0.pre3"
                    - "nvcr.io#nvidia/ai-dynamo/tensorrtllm-runtime:0.6.1-cuda13"

            model:
                description: "Model"
                required: true
                type: choice
                options:
                    - "deepseek-ai/DeepSeek-R1-0528"
                    - "deepseek-r1-fp4"
                    - "openai/gpt-oss-120b"

            precision:
                description: "Precision"
                required: true
                type: choice
                options:
                    - "fp4"
                    - "fp8"

            framework:
                description: "Framework"
                required: true
                type: choice
                options:
                    - "dynamo-trtllm"
                    - "dynamo-sglang"

            mtp:
                description: "Mtp On/Off"
                required: true
                type: choice
                options:
                    - "on"
                    - "off"

            isl:
                description: "ISL"
                required: true
                type: string

            osl:
                description: "OSL"
                required: true
                type: string

jobs:
    pre-run:
        runs-on: ubuntu-latest
        outputs:
            max-model-len: ${{ steps.calc.outputs.max-model-len }}
            model-prefix: ${{ steps.calc.outputs.model-prefix }}
        steps:
            - id: calc
              shell: python
              run: |
                  import os
                  import sys
                  try:
                      isl = int("${{ inputs.isl }}")
                      osl = int("${{ inputs.osl }}")
                  except ValueError:
                      print("Error: ISL and OSL must be integers")
                      sys.exit(1)
                  
                  # Map model names to clean prefixes
                  model = "${{ inputs.model }}"
                  if model == "deepseek-ai/DeepSeek-R1-0528":
                      model_prefix = "dsr1"
                  elif model == "deepseek-r1-fp4":
                      model_prefix = "dsr1-fp4"
                  elif model == "openai/gpt-oss-120b":
                      model_prefix = "gptoss"
                  else:
                      # Fallback: replace slashes with underscores
                      model_prefix = model.replace("/", "_")
                  
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"max-model-len={isl + osl}\n")
                      f.write(f"model-prefix={model_prefix}\n")

    benchmark-gb200:
        needs: pre-run
        uses: ./.github/workflows/benchmark-multinode-tmpl.yml
        name: gb200 test
        secrets: inherit
        with:
            runner: gb200
            image: ${{ inputs.image }}
            model: ${{ inputs.model }}
            framework: ${{ inputs.framework }}
            precision: ${{ inputs.precision }}
            exp-name: ${{ needs.pre-run.outputs.model-prefix }}
            isl: ${{ inputs.isl }}
            osl: ${{ inputs.osl }}
            max-model-len: ${{ needs.pre-run.outputs.max-model-len }}
            mtp-mode: ${{ inputs.mtp }}
