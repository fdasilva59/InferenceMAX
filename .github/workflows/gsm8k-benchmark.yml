name: GSM8k Benchmark

on:
    workflow_dispatch:
        inputs:
            model:
                description: "Model to evaluate (e.g., meta-llama/Llama-3.1-8B-Instruct)"
                required: true
                type: string
                default: "meta-llama/Llama-3.1-8B-Instruct"
            runner:
                description: "Runner to use (e.g., h100-cr, h200-cw, b200-nv, mi300x-amd, mi325x-amd, mi355x-amd)"
                required: true
                type: string
                default: "h100-cr"
            image:
                description: "Docker image to use"
                required: true
                type: string
                default: "vllm/vllm-openai:latest"
            framework:
                description: "Framework to use (vllm, sglang, trt)"
                required: true
                type: string
                default: "vllm"
            precision:
                description: "Precision (fp16, fp8, fp4)"
                required: true
                type: string
                default: "fp16"
            tp:
                description: "Tensor parallelism size"
                required: true
                type: string
                default: "1"
            num-fewshot:
                description: "Number of few-shot examples"
                required: false
                type: string
                default: "5"
            limit:
                description: "Limit number of examples (empty for all)"
                required: false
                type: string
                default: ""

env:
    HF_TOKEN: ${{ secrets.HF_TOKEN }}
    HF_HUB_CACHE: '/mnt/hf_hub_cache/'
    MODEL: ${{ inputs.model }}
    FRAMEWORK: ${{ inputs.framework }}
    PRECISION: ${{ inputs.precision }}
    TP: ${{ inputs.tp }}
    NUM_FEWSHOT: ${{ inputs.num-fewshot }}
    LIMIT: ${{ inputs.limit }}
    IMAGE: ${{ inputs.image }}

jobs:
    gsm8k-eval:
        runs-on: ${{ inputs.runner }}
        timeout-minutes: 180
        name: 'GSM8k - ${{ inputs.model }} - ${{ inputs.framework }} - ${{ inputs.precision }} - tp=${{ inputs.tp }}'
        steps:
            - name: Resource cleanup
              run: |
                  if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                      echo "[Docker] Cleaning up resources ..."
                      docker ps -aq | xargs -r docker rm -f
                      docker network prune -f
                      while [ -n "$(docker ps -aq)" ]; do
                          docker ps -a
                          sleep 5
                      done
                  fi
                  if command -v squeue >/dev/null 2>&1; then
                      echo "[Slurm] Cleaning up resources ..."
                      scancel -u $USER
                      while [ -n "$(squeue -u $USER --noheader --format='%i')" ]; do
                          squeue -u $USER
                          sleep 5
                      done
                  fi

            - uses: actions/checkout@v3
              with:
                  token: ${{ secrets.REPO_PAT }}
                  fetch-depth: 0

            - name: Launch GSM8k evaluation
              env:
                  RUNNER_NAME: ${{ runner.name }}
                  RESULT_FILENAME: gsm8k_${{ env.FRAMEWORK }}_${{ env.PRECISION }}_tp${{ env.TP }}_${{ runner.name }}
              run: |
                  bash ./runners/launch_gsm8k_${RUNNER_NAME%%_*}.sh
                  if [ -f "$RESULT_FILENAME.json" ]; then
                      echo "RESULT_FILENAME=${RESULT_FILENAME}" >> $GITHUB_ENV
                  else
                      echo "Run failed: GSM8k result $RESULT_FILENAME.json not found." >&2
                      exit 1
                  fi

            - name: Upload result
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.RESULT_FILENAME }}
                  path: ${{ env.RESULT_FILENAME }}.json
